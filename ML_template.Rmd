---
title: "ML_template"
author: "Korean Data Team"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: cerulean
    keep_md: true
    toc: true
    toc_width: 10
    toc_float: true
    code_folding: hide
---

<!-- 1.Objective -->
<!-- 2. EDA -->
<!-- 3. Feature Engineering -->
<!-- 4.Machine Learning -->
<!-- 5. Conclusion -->
<!-- Feature Engineering <- Feature Selection, Imputation, Visualization -->
<!-- EDA structure, type, missing portion -->
<!-- Feature Engineering Wranglization -->

# 1. Objectives

* 
* 
*

## a. Load Packages
```{r load_library, eval=FALSE, include=TRUE}
# Load the Packages

# loading package
library(tidyverse)
library(data.table)

# clean columns
library(janitor)

# EDA
library(DataExplorer)
library(naniar)
library(skimr)

# Visualization 
library(plotly)
library(corrplot)
library(DT)
library(ggrepel)
library(corrplot)
library(gridExtra)

# Feature Engineering
library(stringr)
library(lubridate)


# Machine Learning
library(caret)
library(xgboost)
library(rattle)

# Instant load the packages
pacman::p_load(data.table, janitor, tidyverse, DataExplorer, naniar, skimr, plotly, corrplot, DT, gridExtra, ggrepel, stringi, lubridate, caret, xgboost, rattle)
```

## b. Load the data
```{r load_data, eval=FALSE, include=TRUE}
# Clean the name of variables (lower.case & '_' connection) by using Janitor package

# Method 1
train <- fread(file = "url", stringsAsFactors = F, na.strings= c("NA","")) %>% clean_names()

# Method 2
test <- read_csv(file = "url", header = TRUE, na = c("NA", ""), n_max = Inf, guess_max = min(1000, n_max)) %>% clean_names()

test$target <- NA

dat <- rbind(train, test)
```

## c. Load Multiple files in one directory
```{r load_multi, eval=FALSE, include= TRUE}
file_list <- sapply("directory",function(x){list.files(x,pattern = "csv")})
for (i in file_list){
  assign(str_extract(i, "[a-z|A-Z|_]+(?=\\.)"), fread(i, stringsAsFactors = F, na.strings= c("NA","")))
}
```

# 2. EDA (Expolatory Data Analysis)

## a. Scales of data 

```{r attr_data, eval=FALSE, include=TRUE}
# ncol() | nrow()
cat("Train dataset' has", dim(train)[1], "rows and", dim(train)[2], "columns."
    "\n Test dataset has",dim(test)[1], "rows and", dim(test)[2], "columns.")
```

## b. Structure of data

```{r str_data, eval = F, include = TRUE}
for (i in c(train, test)) {
  str(i)
  summary(i)
  glimpse(i)
  # skimr package
  skim_tee(i)
}
```

## b. Type of variables 

```{r summary_data, eval=FALSE, include=TRUE}
lapply(dat, typeof) %>% data.frame() %>%  t() %>%  as.data.frame() 
```


## c. How many missing values for each dataset?

```{r missing_transform, eval=FALSE, include=TRUE}
# missing_transform (optional)
# dat <- sapply(dat, function(x) {ifelse(is.character(x) & nchar(x) == 0, NA, x)}) %>% data.frame(stringsAsFactors = F) 
# Careful to not use as.data.frame()
```

```{r missing_table}
colSums(is.na(train)) %>% data.frame()
colSums(is.na(test)) %>% data.frame()
```

```{r show_missing_value, fig.show = 'hide', eval=FALSE, include=TRUE}
# Show missing value - visualization
missing_train <- plot_missing(train, missing_only = T, theme_config = list(legend.position = "right"), ggtheme = theme_light(), title = "Train missing") %>% ggplotGrob()
missing_test <- plot_missing(test, theme_config = list(legend.position = "right"), ggtheme = theme_light(), title = "Test missing") %>% ggplotGrob()
```

```{r missing_result, fig.height= 6, eval=FALSE, include=TRUE}
# Show missing result by using grid
grid.arrange(missing_train, missing_test, ncol = 1)
```

- The missing plot per variable can be created with $naniar$ Package as well below

- There is $gg\_miss\_var$ plot which indicates how much proportion of missing values in $nanair$ pacakge below. 

```{r nanair_1, eval=FALSE, include=TRUE}
# Show missing values by using naniar package
gmv1 <- naniar::gg_miss_var(train, show_pct = T)
gmv2 <- naniar::gg_miss_var(test, show_pct = T)
grid.arrange(gmv1, gmv2, nrow = 1)
```

- Also, it can be visualized with other way shown below. (Not recommended)

```{r nanair_2, fig.height= 10, eval=FALSE, include=TRUE}
# Show missing values by using naniar package (Not recommended)
m1 <- naniar::vis_miss(train, warn_large_data = F) + labs(title = "train missing")
m2 <- naniar::vis_miss(test, warn_large_data = F) + labs(title = "test missing")
grid.arrange(m1, m2, ncol = 1)
```

- Here is own created missing viz method

```{r missing_viz}
missing_clock_plot <-  function(x){
  colSums(is.na(x)) %>% 
    data.frame() %>% 
    rownames_to_column() %>%
    mutate(pct = ./nrow(x)) %>% 
    ggplot(aes(x = rowname, y = .)) +
    geom_text(aes(label = ifelse(pct == 0, "", paste(round(pct,2) * 100,"%")), size = 5), show.legend = F) +
    geom_bar(stat = "identity", fill = "red", alpha = 0.5) +
    coord_polar(theta = "x") +
    labs(x = "Missing number", y = "Variables", title = "Missing Value per Variable") +
    theme_minimal() +
    theme(panel.grid.major.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_text(size = 10, family = "sans"))
}

missing_clock_plot(train)
missing_clock_plot(test)
```

## d. Switching original features to any datatype(i.e. numeric, characater, date, ...) value with condition (mutate_at)

```{r type_switch, eval=FALSE, include=TRUE}
# Using mutate_at
# train <- train %>% mutate_at(colnames(data1) %>% grep("gpa|act|credits", ., value =T), as.numeric)
# test <- test %>% mutate(total_meeting_duration = total_meeting_duration %>% as.numeric())

t1 <- train %>% select_if(is.numeric) %>% colnames() %>% data.frame() 
t2 <- test %>% select_if(is.numeric) %>% colnames() %>% data.frame()
rbind(t1, t2) %>% mutate(type = "Numeric") # Create 'type' column
```

## e. DataExplorer Package 

```{r DE, fig.show = 'hide', eval=FALSE, include=TRUE}
# DataExplor package - numeric variable & categorical variable & row & column
t1 <- DataExplorer::introduce(data1) %>% t() %>% as.data.frame() %>% rownames_to_column("attribute")
t2 <- DataExplorer::introduce(data2) %>% t() %>% as.data.frame() %>% rownames_to_column("attribute")

# DataExplor package - Visualization
p1 <- DataExplorer::plot_intro(data1, title = "train", ggtheme = theme_bw())
p2 <- DataExplorer::plot_intro(data2, title = "test", ggtheme = theme_bw())
```

```{r DE_result,  fig.height= 6, fig.width=  10, eval=FALSE, include=TRUE}
# Combine tables and plots in a row.
grid.arrange(p1, tableGrob(t1, rows=NULL), tableGrob(t2, rows=NULL), p2,  ncol = 2, top = "Attributes of datasets")
```


# 3. Feature Engineering 
## (Feature selection, Imputation, Visualization)

## a. Feature Selction

1. method 1 - Correlation plot

```{r cor}
cor <- cor(train %>% select_if(is.numeric))
corrplot(cor, method = c("number"), type = "upper", tl.col = "black", diag = T)
```
## a. data1 & data2 Joining key

```{r joining, eval=FALSE, include=TRUE}
# without function
joining_key <- data1[,which(colnames(data1) %in% colnames(data2))] %>% colnames()

join_data <- 
  left_join(data1, data2, by = joining_key)

# with function (natural join)
natural_join <- function(x,y){
  x %>% left_join(y, by = x[,which(colnames(x) %in% colnames(y))] %>% colnames())
}

join_data <-
  data1 %>% natural_join(data2)


# datatable(join_data %>% head(100), options = list(scrollX = T))
```

## b. Target Exploration

```{r target, eval=FALSE, include=TRUE}
join_data %>% group_by('target column') %>% tally() %>% mutate(pct = n/sum(n))
```

# 4. Machine Learning


## 1. Target Distribution

```{r taget, eval=FALSE, include=TRUE}
proportion <- dat %>% group_by(target) %>% tally() %>%  mutate(pct = round(n/sum(n),2))
proportion
```


## 2. Identify the missing variables and impute the part (median)

```{r missing_impute, warning = F, eval=FALSE, include=TRUE}
naniar::gg_miss_var(dat, show_pct = T)

# advising_student_final %>% ggplot() +
#   geom_histogram(aes(x = act_composite, fill = enrollment_status)) +
#   facet_wrap(~ enrollment_status) +
#   theme_minimal()
# 
# advising_student_final %>% ggplot() +
#   geom_histogram(aes(x = high_school_gpa, fill = enrollment_status)) +
#   facet_wrap(~ enrollment_status) +
#   theme_minimal()

# advising_student_final %>% group_by(enrollment_status) %>% summarise(act_median = median(act_composite, na.rm = T), hs_gpa_median = median(high_school_gpa, na.rm = T))
# 
# advising_student_final[advising_student_final$enrollment_status == "Graduated" & is.na(advising_student_final$act_composite),"act_composite"] <- 22
# advising_student_final[advising_student_final$enrollment_status == "Not Graduated" & is.na(advising_student_final$act_composite),"act_composite"] <- 22
# advising_student_final[advising_student_final$enrollment_status == "Graduated" & is.na(advising_student_final$high_school_gpa),"high_school_gpa"] <- 3.46
# advising_student_final[advising_student_final$enrollment_status == "Not Graduated" & is.na(advising_student_final$high_school_gpa),"high_school_gpa"] <- 3.24

# advising_student_final <- advising_student_final %>% mutate_if(is.character, as.factor) %>% mutate_if(is.logical, as.factor) %>% select(-c(identifier))
 
# sapply(advising_student_final, class)

naniar::gg_miss_var(advising_student_final, show_pct = T)
```

```{r modeling_1, eval=FALSE, include=TRUE}
set.seed(1000)
InTraining <- caret::createDataPartition(advising_student_final$enrollment_status, p = .7, list = F)
Train <- advising_student_final %>% slice(InTraining)
Test <- advising_student_final %>% slice(-InTraining)

ModelFit_1 <- train(enrollment_status ~ ., data = Train, method = "rf", importance = T)
ModelFit_2 <- train(enrollment_status ~ ., data = Train, method = "rpart")
```

```{r modeling_2, fig.height= 7, eval=FALSE, include=TRUE}
varimp1 <- ggplot(varImp(ModelFit_1)) + geom_label(aes(label = paste0(round(Importance),"%"))) + theme_bw() + labs(title = "Random Forest") + theme(plot.title = element_text(hjust = 0.5))
varimp2 <- ggplot(varImp(ModelFit_1)) + geom_label(aes(label = paste0(round(Importance),"%"))) + theme_bw() + labs(title = "RPart") + theme(plot.title = element_text(hjust = 0.5))
grid.arrange(varimp1, varimp2, ncol = 1)
```

```{r modeling_3, eval=FALSE, include=TRUE}
caret::confusionMatrix(Test$enrollment_status ,predict(ModelFit_1, Test))
caret::confusionMatrix(Test$enrollment_status ,predict(ModelFit_2, Test))
```


```{r modeling_4, eval=FALSE, include=TRUE}
fancyRpartPlot(ModelFit_2$finalModel)
```

```{r modeling_5, eval=FALSE, include=TRUE}
colSums(is.na(advising_student_final))

advising_student_final <- advising_student_final %>% mutate(pred = predict(ModelFit_1, advising_student_final))

confusionMatrix(advising_student_final$enrollment_status, advising_student_final$pred)
```









# * Useful Code *

### round(), percentage

```{r round, eval=FALSE, include=TRUE}
table(advising_student_fs$enrollment_status) %>% data.frame() %>% mutate(Pct = round(Freq / sum(Freq) * 100, 2))
```


### ggplot help

```{r ggplot1, eval=FALSE, include=TRUE}
t1 <- advising_student_fs %>% 
  group_by(enrollment_status) %>% 
  summarise(mean = mean(sum_of_cumulative_missing_credit, na.rm = T)) 

advising_student_fs %>% 
  ggplot(aes(x = enrollment_status, y = sum_of_cumulative_missing_credit)) +
  geom_jitter(alpha = 0.3, color = "gray") +
  geom_violin(aes(fill = enrollment_status)) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip() +
  annotation_custom(tableGrob(t1, rows = NULL), xmin= 0.5, xmax=  1 , ymin= 50 , ymax= 60)
```


### Lubridate::%--% = as.interval()

##### Ex1
```{r lubridate1, eval=FALSE, include=TRUE}
fix_year <- function(x, year=1919){ #since this year is 2019, if year digits are over 19, it is regared as 1900 century.
  m <- year(x) %% 100
  year(x) <- ifelse(m > year %% 100, 1900+m, 2000+m)
  x
}

advising_student_fs <-
advising_student_fs %>% 
  mutate(mission_enter_date = mdy(mission_enter_date) %>% fix_year(), mission_release_date = mdy(mission_release_date) %>% fix_year()) %>% 
  mutate(served_mission = mission_enter_date %--% mission_release_date %>% as.duration()/ ddays(1)) %>% 
  mutate(served_mission = case_when(
    is.na(served_mission) ~ "N",
    served_mission < 100 ~ "H",
    TRUE ~ "F"
  ))
```

##### Ex2
```{r lubridate2, eval=FALSE, include=TRUE}
advising_student_fs <- 
advising_student_fs %>% 
  mutate(age = round(mdy(birth_date) %>% fix_year() %--% ymd(paste0(20,parse_number(term_code)), truncated = 2L) %>% as.duration() / dyears(1)))
```



################################################

## - Subprogram (Dayschool VS Online)

```{r subprogram, eval=FALSE, include=TRUE}
advising_student_fs <-
advising_student_fs %>% 
  mutate(subprogram = substring(subprogram,1,1))
```

- Students can be classified into in-school student (D) or online student. (O)

## - Check if student transferred from other institution

```{r transfer, eval=FALSE, include=TRUE}
advising_student_fs <-
advising_student_fs %>% 
  mutate(transfer = ifelse(transfer_earned_credits > 0, 1, 0) %>% as.factor())

advising_student_fs %>% group_by(transfer) %>% count()
```


## - Top 5 Major by level(degree) 

```{r major, eval=FALSE, include=TRUE}
major_fs <- advising_student_fs %>% group_by(level, major) %>% tally(sort = T)

major_fs %>% group_by(level) %>% top_n(5) %>% ungroup() %>% 
  ggplot(aes(x = parse_number(major) %>% as.factor() %>% reorder(n), y = n)) +
  geom_col(aes(fill = level)) +
  geom_label(aes(label = str_extract(major, "[:alpha:]+"))) +
  facet_wrap(level ~., scales = "free", ncol = 1) +
  coord_flip() +
  theme_bw() +
  labs(x = "Major", y = "Count", title = "Top 5 Major by degree") +
  scale_fill_discrete(label = c("Assocaite", "Bachelor"))
```

## - Top 5 Advising Reason by level(degree)

```{r advising_reason, fig.height= 6, fig.width= 12, eval=FALSE, include=TRUE}
advising_reason_fs <-
  advising_student_fs %>% group_by(level, advising_reason, enrollment_status) %>% count() %>% ungroup() %>% group_by(level, enrollment_status) %>% top_n(5, n)

advising_reason_fs %>% ggplot(aes(x = reorder(advising_reason, -n), y = n)) +
  geom_col(aes(fill = level), position = "dodge") +
  facet_wrap( level ~ enrollment_status, scales = "free") +
  theme_light() +
  coord_flip() +
  theme(legend.position = "top") +
  labs(x = "", y = "") +
  scale_fill_discrete(labels = c("Associate","Bachelor")) +
  labs(caption = "We can see that Graduated Students are more likely to visit advising center with the reason of Glad Planner & Class Planning compared to others")
```


## - Aggregate the data group by student id (Identifier)

After feature engineering, I aggregated the data by distinct Identifier to manage the individual data of each student.

```{r aggregation, eval=FALSE, include=TRUE}
advising_student_final <- 
advising_student_fs %>% 
  group_by(identifier) %>% 
  arrange(cumulative_earned_credits) %>% 
  summarise(total_meeting_duration = sum(total_meeting_duration),
            number_of_semester = length(enrolled_current_semester[unique(term_code)] %>% str_detect("T")) ,
            classification_begin = head(classification_begin,1),
            served_mission = head(served_mission,1),
            subprogram = head(subprogram,1),
            gender = head(gender, 1),
            act_composite = mean(act_composite),
            high_school_gpa = mean(high_school_gpa),
            level = head(level, 1),
            cumulative_gpa = tail(cumulative_gpa, 1),
            transfer = head(transfer, 1),
            age = round(mean(age)),
            cumulative_earned_credits = head(cumulative_earned_credits, 1),
            cumulative_attempted_credits = head(cumulative_attempted_credits, 1),
            cumulative_missing_credit = round(max(cumulative_attempted_credits) - (max(cumulative_earned_credits) - head(transfer_earned_credits,1)),2),
            cumulative_campus_earned_credit = max(cumulative_earned_credits) - head(transfer_earned_credits,1),
            transfer_earned_credits = mean(transfer_earned_credits, na.rm = T),
            # target variable
            enrollment_status = head(enrollment_status, 1)) %>% 
  ungroup()

# datatable(advising_student_final,)
```




